version: '3.8'

services:
  tak-token-manager:
    build: .
    container_name: tak-token-manager
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - TAK_SERVER_HOST=${TAK_SERVER_HOST:-10.123.123.2}
      - TAK_SERVER_PORT=${TAK_SERVER_PORT:-8089}
      - TAK_API_URL=${TAK_API_URL}
      - TAK_ADMIN_USER=${TAK_ADMIN_USER}
      - TAK_ADMIN_PASS=${TAK_ADMIN_PASS}
      - TOKEN_EXPIRY_MINUTES=${TOKEN_EXPIRY_MINUTES:-120}
      - DATABASE_URL=postgresql://takuser:takpass@db:5432/takdb
      - SECRET_KEY=${SECRET_KEY}
      - PUBLIC_URL=${PUBLIC_URL:-http://10.123.123.2:5000}
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - FROM_EMAIL=${FROM_EMAIL}
      - FROM_NAME=${FROM_NAME:-TAK Server Admin}
    volumes:
      - ./config:/app/config:ro
      - ./data:/app/data
      - ./logs:/app/logs
      - token-packages:/app/packages
      - ./app:/app/app:ro
    depends_on:
      - db
    networks:
      - tak-network

  db:
    image: postgres:15-alpine
    container_name: tak-token-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=takdb
      - POSTGRES_USER=takuser
      - POSTGRES_PASSWORD=takpass
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - tak-network

volumes:
  postgres-data:
  token-packages:

networks:
  tak-network:
    driver: bridge
